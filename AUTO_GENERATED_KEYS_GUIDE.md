# Auto-Generated Keys Guide

This guide explains how to use auto-generated keys in spring-data-dynamodb 7.0.0 (SDK v2) for both existing SDK v1 users and new SDK v2 users.

## Overview

Auto-generated keys automatically populate ID fields with UUIDs or timestamps before saving entities to DynamoDB. This eliminates the need to manually set these values in your application code.

---

## For SDK_V2_NATIVE Users (New Projects)

### Step 1: Configure DynamoDbEnhancedClient

You **MUST** configure the `AutoGeneratedUuidExtension` when building the enhanced client:

```java
import software.amazon.awssdk.enhanced.dynamodb.DynamoDbEnhancedClient;
import software.amazon.awssdk.enhanced.dynamodb.extensions.AutoGeneratedUuidExtension;
import software.amazon.awssdk.services.dynamodb.DynamoDbClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class DynamoDBConfig {

    @Bean
    public DynamoDbClient dynamoDbClient() {
        return DynamoDbClient.builder()
            .region(Region.US_EAST_1)
            .build();
    }

    @Bean
    public DynamoDbEnhancedClient dynamoDbEnhancedClient(DynamoDbClient dynamoDbClient) {
        return DynamoDbEnhancedClient.builder()
            .dynamoDbClient(dynamoDbClient)
            .extensions(AutoGeneratedUuidExtension.create())  // ⚠️ REQUIRED for auto-generated UUIDs
            .build();
    }

    @Bean
    public DynamoDBTemplate dynamoDBTemplate(
            DynamoDbClient dynamoDbClient,
            DynamoDbEnhancedClient enhancedClient) {
        return new DynamoDBTemplate(dynamoDbClient, enhancedClient, null, null);
    }
}
```

### Step 2: Annotate Entity Fields

Use SDK v2's `@DynamoDbAutoGeneratedUuid` annotation:

```java
import software.amazon.awssdk.enhanced.dynamodb.mapper.annotations.*;
import software.amazon.awssdk.enhanced.dynamodb.extensions.annotations.DynamoDbAutoGeneratedUuid;

@DynamoDbBean
public class Product {

    @DynamoDbPartitionKey
    @DynamoDbAutoGeneratedUuid  // ✅ Generates UUID automatically
    private String productId;

    @DynamoDbAttribute
    private String name;

    @DynamoDbAttribute
    private Double price;

    // Getters and setters...
}
```

### Usage

```java
@Service
public class ProductService {

    @Autowired
    private ProductRepository productRepository;

    public void createProduct() {
        Product product = new Product();
        // Don't set productId - it will be auto-generated
        product.setName("Widget");
        product.setPrice(19.99);

        productRepository.save(product);
        // After save, product.getProductId() will have a UUID like "550e8400-e29b-41d4-a716-446655440000"
    }
}
```

### Important Notes

**Supported Field Type:**
- **ONLY** `String` fields are supported
- UUID format: `550e8400-e29b-41d4-a716-446655440000`

**Auto-Generation Behavior:**
- UUIDs are generated **only if the field is null or empty**
- If you manually set a value, it won't be overwritten
- Works for both single `save()` and `batchSave()` operations

**Timestamp Support:**
- ❌ SDK v2 does NOT have built-in auto-generated timestamp support
- You must manually set timestamps in your code or use Spring Data's `@CreatedDate` / `@LastModifiedDate` with auditing

---

## For SDK_V1_COMPATIBLE Users (Migrating from SDK v1)

### Migration Steps

**Before (SDK v1):**
```java
import com.amazonaws.services.dynamodbv2.datamodeling.*;

@DynamoDBTable(tableName = "Products")
public class Product {

    @DynamoDBHashKey
    @DynamoDBAutoGeneratedKey
    private String productId;  // Auto-generated UUID

    @DynamoDBAttribute
    @DynamoDBAutoGeneratedTimestamp(strategy = DynamoDBAutoGenerateStrategy.CREATE)
    private Date createdAt;  // Auto-generated on create

    @DynamoDBAttribute
    @DynamoDBAutoGeneratedTimestamp(strategy = DynamoDBAutoGenerateStrategy.ALWAYS)
    private Date updatedAt;  // Auto-generated on create and update

    // Getters and setters...
}
```

**After (SDK v2 with SDK_V1_COMPATIBLE mode):**
```java
import software.amazon.awssdk.enhanced.dynamodb.mapper.annotations.*;
// Import auto-generation annotations from spring-data-dynamodb
import org.socialsignin.spring.data.dynamodb.annotation.DynamoDBAutoGeneratedKey;
import org.socialsignin.spring.data.dynamodb.annotation.DynamoDBAutoGeneratedTimestamp;
import org.socialsignin.spring.data.dynamodb.annotation.DynamoDBAutoGenerateStrategy;

@DynamoDbBean
public class Product {

    @DynamoDbPartitionKey
    @DynamoDBAutoGeneratedKey  // ✅ Use spring-data-dynamodb annotation
    private String productId;

    @DynamoDbAttribute
    @DynamoDBAutoGeneratedTimestamp(strategy = DynamoDBAutoGenerateStrategy.CREATE)  // ✅ Use spring-data-dynamodb annotation
    private Date createdAt;

    @DynamoDbAttribute
    @DynamoDBAutoGeneratedTimestamp(strategy = DynamoDBAutoGenerateStrategy.ALWAYS)  // ✅ Use spring-data-dynamodb annotation
    private Date updatedAt;

    // Getters and setters...
}
```

### Configuration

```java
@Configuration
@EnableDynamoDBRepositories(basePackages = "com.example.repositories")
public class DynamoDBConfig {

    @Bean
    public DynamoDbClient dynamoDbClient() {
        return DynamoDbClient.builder()
            .region(Region.US_EAST_1)
            .build();
    }

    @Bean
    public DynamoDbEnhancedClient dynamoDbEnhancedClient(DynamoDbClient dynamoDbClient) {
        return DynamoDbEnhancedClient.builder()
            .dynamoDbClient(dynamoDbClient)
            // NO need to add AutoGeneratedUuidExtension for SDK_V1_COMPATIBLE mode
            .build();
    }

    @Bean
    public DynamoDBMappingContext dynamoDBMappingContext() {
        return new DynamoDBMappingContext(MarshallingMode.SDK_V1_COMPATIBLE);  // ⚠️ SET MODE
    }

    @Bean
    public DynamoDBTemplate dynamoDBTemplate(
            DynamoDbClient dynamoDbClient,
            DynamoDbEnhancedClient enhancedClient,
            DynamoDBMappingContext mappingContext) {
        return new DynamoDBTemplate(dynamoDbClient, enhancedClient, null, mappingContext);
    }
}
```

### Key Changes

| SDK v1 | SDK v2 (SDK_V1_COMPATIBLE) |
|--------|----------------------------|
| `@DynamoDBHashKey` | `@DynamoDbPartitionKey` |
| `import com.amazonaws...DynamoDBAutoGeneratedKey` | `import org.socialsignin...DynamoDBAutoGeneratedKey` |
| `import com.amazonaws...DynamoDBAutoGeneratedTimestamp` | `import org.socialsignin...DynamoDBAutoGeneratedTimestamp` |
| No configuration needed | Set `MarshallingMode.SDK_V1_COMPATIBLE` |

### Supported Features in SDK_V1_COMPATIBLE Mode

**@DynamoDBAutoGeneratedKey:**
- ✅ Generates UUID for `String` fields
- ✅ Only generates if field is null or empty
- ✅ Works on fields and getter methods
- ✅ Supports inheritance (checks parent class fields)

**@DynamoDBAutoGeneratedTimestamp:**
- ✅ Generates current timestamp for `Date` or `Long` fields
- ✅ Only generates if field is null
- ✅ Supports `DynamoDBAutoGenerateStrategy.CREATE` (generate on create only)
- ✅ Supports `DynamoDBAutoGenerateStrategy.ALWAYS` (generate on create and update)
- ✅ Works on fields and getter methods
- ✅ Supports inheritance

---

## Complete Examples

### Example 1: SDK_V2_NATIVE - Simple UUID Generation

```java
// Configuration
@Bean
public DynamoDbEnhancedClient dynamoDbEnhancedClient(DynamoDbClient client) {
    return DynamoDbEnhancedClient.builder()
        .dynamoDbClient(client)
        .extensions(AutoGeneratedUuidExtension.create())
        .build();
}

// Entity
@DynamoDbBean
public class Order {
    @DynamoDbPartitionKey
    @DynamoDbAutoGeneratedUuid
    private String orderId;

    @DynamoDbAttribute
    private String customerId;

    @DynamoDbAttribute
    private Double total;

    // Manual timestamp management
    @DynamoDbAttribute
    private Date orderDate;

    // Getters and setters...
}

// Service
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;

    public Order createOrder(String customerId, Double total) {
        Order order = new Order();
        // orderId will be auto-generated
        order.setCustomerId(customerId);
        order.setTotal(total);
        order.setOrderDate(new Date());  // Must set manually

        return orderRepository.save(order);
    }
}
```

### Example 2: SDK_V1_COMPATIBLE - UUID and Timestamp Generation

```java
// Configuration
@Bean
public DynamoDBMappingContext dynamoDBMappingContext() {
    return new DynamoDBMappingContext(MarshallingMode.SDK_V1_COMPATIBLE);
}

// Entity
import org.socialsignin.spring.data.dynamodb.annotation.*;

@DynamoDbBean
public class AuditLog {
    @DynamoDbPartitionKey
    @DynamoDBAutoGeneratedKey
    private String logId;

    @DynamoDbAttribute
    private String userId;

    @DynamoDbAttribute
    private String action;

    @DynamoDbAttribute
    @DynamoDBAutoGeneratedTimestamp(strategy = DynamoDBAutoGenerateStrategy.CREATE)
    private Date createdAt;

    @DynamoDbAttribute
    @DynamoDBAutoGeneratedTimestamp(strategy = DynamoDBAutoGenerateStrategy.ALWAYS)
    private Date modifiedAt;

    // Getters and setters...
}

// Service
@Service
public class AuditService {
    @Autowired
    private AuditLogRepository auditLogRepository;

    public AuditLog logAction(String userId, String action) {
        AuditLog log = new AuditLog();
        // logId, createdAt, and modifiedAt will be auto-generated
        log.setUserId(userId);
        log.setAction(action);

        return auditLogRepository.save(log);
    }

    public void updateLog(String logId, String newAction) {
        AuditLog log = auditLogRepository.findById(logId).orElseThrow();
        log.setAction(newAction);

        auditLogRepository.save(log);
        // modifiedAt will be updated automatically
        // createdAt will remain unchanged (strategy = CREATE)
    }
}
```

---

## Comparison: SDK_V1_COMPATIBLE vs SDK_V2_NATIVE

| Feature | SDK_V1_COMPATIBLE | SDK_V2_NATIVE |
|---------|-------------------|---------------|
| **UUID Generation** | `@DynamoDBAutoGeneratedKey` | `@DynamoDbAutoGeneratedUuid` |
| **Timestamp Generation** | ✅ `@DynamoDBAutoGeneratedTimestamp` | ❌ Not supported |
| **Configuration Required** | Set `MarshallingMode.SDK_V1_COMPATIBLE` | Add `AutoGeneratedUuidExtension` to enhanced client |
| **Supported Field Types (UUID)** | String only | String only |
| **Supported Field Types (Timestamp)** | Date, Long | N/A |
| **Strategy Support** | CREATE, ALWAYS | N/A |
| **Migration Effort** | Low (keep SDK v1 annotations) | Medium (add extension, change annotations) |

---

## Troubleshooting

### UUID not being generated (SDK_V2_NATIVE)

**Cause:** `AutoGeneratedUuidExtension` not configured
**Solution:**
```java
@Bean
public DynamoDbEnhancedClient dynamoDbEnhancedClient(DynamoDbClient client) {
    return DynamoDbEnhancedClient.builder()
        .dynamoDbClient(client)
        .extensions(AutoGeneratedUuidExtension.create())  // ADD THIS
        .build();
}
```

### UUID not being generated (SDK_V1_COMPATIBLE)

**Cause:** Marshalling mode not set or wrong annotation
**Solution:** Ensure `MarshallingMode.SDK_V1_COMPATIBLE` is set AND use `@DynamoDBAutoGeneratedKey` annotation

### Timestamp not being generated

**Cause:** Timestamp auto-generation only works in SDK_V1_COMPATIBLE mode
**Solution:** Either:
1. Use SDK_V1_COMPATIBLE mode with `@DynamoDBAutoGeneratedTimestamp`
2. Manually set timestamps in your code
3. Use Spring Data auditing with `@CreatedDate` / `@LastModifiedDate`

### UUID already set but still being overwritten

**Cause:** Auto-generation only skips if field is **null or empty string**
**Solution:** This is expected behavior. If you don't want auto-generation, don't use the annotation

### Field type not supported

**Cause:** Auto-generated UUID only works with `String` fields
**Solution:** Change field type to `String` or remove the annotation

---

## Migration Checklist

For SDK v1 users migrating to SDK_V1_COMPATIBLE mode:

- [ ] Set `MarshallingMode.SDK_V1_COMPATIBLE` in DynamoDBMappingContext
- [ ] Change `@DynamoDBHashKey` → `@DynamoDbPartitionKey`
- [ ] Change `@DynamoDBRangeKey` → `@DynamoDbSortKey` (if applicable)
- [ ] Change imports for auto-generation annotations from `com.amazonaws...` → `org.socialsignin...`
- [ ] Keep `@DynamoDBAutoGeneratedKey` annotation usage (just update import)
- [ ] Keep `@DynamoDBAutoGeneratedTimestamp` annotation usage (just update import)
- [ ] Test create and update operations
- [ ] Verify timestamps are generated correctly

For new SDK v2 projects:

- [ ] Add `AutoGeneratedUuidExtension` to DynamoDbEnhancedClient configuration
- [ ] Use `@DynamoDbAutoGeneratedUuid` for UUID fields
- [ ] Manually handle timestamps (no auto-generation support)
- [ ] Test save operations

---

## Summary

### SDK_V2_NATIVE (New Users)
✅ Clean SDK v2 approach
✅ Uses native SDK v2 extension
❌ Requires bean configuration
❌ No timestamp support

### SDK_V1_COMPATIBLE (Existing Users)
✅ Keep SDK v1 annotations
✅ Full UUID and timestamp support
✅ Less migration work
✅ Works automatically when mode is set

**Auto-generated keys make development easier by eliminating boilerplate ID/timestamp management code!**
